<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budman78 - Manajemen Keuangan & Stok Multi-Toko</title>
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
            --font-family: 'Segoe UI', system-ui, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .sidebar {
            width: 260px;
            background-color: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }
        
        .logo span { color: white; }

        .nav-links { list-style: none; flex: 1; overflow-y: auto; }
        .nav-item { margin-bottom: 0.5rem; }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #94a3b8;
            text-decoration: none;
            border-radius: var(--radius);
            transition: all 0.2s;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--primary);
            color: white;
        }

        .nav-link svg { margin-right: 12px; width: 20px; height: 20px; }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            position: relative;
        }

        /* --- COMPONENTS --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-warning { background-color: var(--warning); color: white; }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* --- DASHBOARD --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }
        .stat-card.income { border-color: var(--success); }
        .stat-card.expense { border-color: var(--danger); }

        .stat-label { font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }

        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding-top: 20px;
            border-bottom: 1px solid var(--border);
        }
        .bar-group { display: flex; flex-direction: column; align-items: center; width: 15%; height: 100%; justify-content: flex-end; }
        .bar { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.5s ease; position: relative; }
        .bar:hover::after {
            content: attr(data-value);
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;
        }
        .bar.income { background-color: var(--success); }
        .bar.expense { background-color: var(--danger); }
        .bar-label { margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); }

        /* --- TABLES --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { font-weight: 600; color: var(--text-muted); background-color: #f8fafc; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        
        .badge {
            padding: 0.25rem 0.6rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-in { background: #dcfce7; color: #166534; }
        .badge-out { background: #fee2e2; color: #991b1b; }
        .badge-low { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        
        .modal {
            background: white; padding: 2rem; border-radius: var(--radius);
            width: 100%; max-width: 500px;
            transform: translateY(-20px); transition: transform 0.3s;
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.open .modal { transform: translateY(0); }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 0.6rem;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-family: inherit; font-size: 0.95rem;
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 1.5rem; }
        
        .row-inputs { display: flex; gap: 10px; }
        .row-inputs > div { flex: 1; }

        /* --- TOAST --- */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        .toast {
            background: #333; color: white; padding: 12px 24px;
            border-radius: var(--radius); margin-top: 10px;
            box-shadow: var(--shadow);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- VIEWS UTILITY --- */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .app-footer { margin-top: 3rem; text-align: center; color: var(--text-muted); font-size: 0.9rem; border-top: 1px solid var(--border); padding-top: 1rem; }

        @media (max-width: 768px) {
            .sidebar { position: absolute; left: -260px; height: 100%; z-index: 999; }
            .sidebar.active { left: 0; }
            .main-content { padding: 1rem; }
            .menu-toggle { display: block; }
        }
        .menu-toggle { display: none; background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* Inventory Specific */
        .stock-control { display: flex; align-items: center; gap: 5px; }
        .stock-btn { width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border); background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .stock-btn:hover { background: #f8fafc; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M5 21V7l8-4 8 4v14"/><path d="M17 21v-8.5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0-.5.5V21"/></svg>
            <span>sample</span>
        </div>
        <ul class="nav-links">
            <li class="nav-item">
                <a class="nav-link active" onclick="app.navigate('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="app.navigate('stores')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Daftar Toko
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="app.navigate('inventory')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                    Stok Barang
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="app.navigate('transactions')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    Transaksi
                </a>
            </li>
        </ul>
        <div style="font-size: 0.8rem; color: #64748b; margin-top: auto;">
            &copy; 2026 budman78
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <div class="header">
            <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">‚ò∞</button>
            <h2 id="page-title">Dashboard</h2>
            <div class="user-profile">
                <span style="color: var(--text-muted); font-size: 0.9rem;">Admin Utama</span>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <section id="view-dashboard" class="view-section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Saldo Semua Toko</div>
                    <div class="stat-value" id="dash-total-balance">Rp 0</div>
                </div>
                <div class="stat-card income">
                    <div class="stat-label">Total Pemasukan</div>
                    <div class="stat-value" style="color: var(--success);" id="dash-total-income">Rp 0</div>
                </div>
                <div class="stat-card expense">
                    <div class="stat-label">Total Pengeluaran</div>
                    <div class="stat-value" style="color: var(--danger);" id="dash-total-expense">Rp 0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Item Barang</div>
                    <div class="stat-value" id="dash-total-items">0</div>
                </div>
            </div>

            <div class="card">
                <h3>Laporan Keuangan</h3>
                <div class="chart-container" id="chart-bars"></div>
            </div>

            <div class="card">
                <h3>Transaksi Terakhir</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Toko</th>
                                <th>Kategori</th>
                                <th>Nominal</th>
                                <th>Tipe</th>
                            </tr>
                        </thead>
                        <tbody id="dash-recent-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- STORES VIEW -->
        <section id="view-stores" class="view-section">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <button class="btn btn-primary" onclick="app.openModal('store')">+ Tambah Toko</button>
            </div>
            <div class="stats-grid" id="stores-grid"></div>
        </section>

        <!-- INVENTORY VIEW -->
        <section id="view-inventory" class="view-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h3>Daftar Stok Barang</h3>
                    <button class="btn btn-primary" onclick="app.openModal('item')">+ Tambah Barang</button>
                </div>
                
                <!-- Filter/Search placeholder (Visual only for this sample) -->
                <div style="margin-bottom: 1rem; display: flex; gap: 10px;">
                    <input type="text" id="search-inventory" class="form-input" placeholder="Cari nama barang..." onkeyup="app.renderInventory()" style="max-width: 300px;">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Nama Barang</th>
                                <th>Toko</th>
                                <th>Harga Beli</th>
                                <th>Harga Jual</th>
                                <th>Stok</th>
                                <th>Nilai Aset</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- TRANSACTIONS VIEW -->
        <section id="view-transactions" class="view-section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 10px;">
                    <h3>Riwayat Transaksi</h3>
                    <button class="btn btn-primary" onclick="app.openModal('transaction')">+ Catat Transaksi</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Toko</th>
                                <th>Deskripsi</th>
                                <th>Tipe</th>
                                <th>Nominal</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <footer class="app-footer">
            &copy; 2026 budman78 - Aplikasi Manajemen Toko
        </footer>
    </main>

    <!-- MODAL ADD STORE -->
    <div class="modal-overlay" id="modal-store">
        <div class="modal">
            <h3 style="margin-bottom: 1rem;">Tambah Toko Baru</h3>
            <form onsubmit="app.handleAddStore(event)">
                <div class="form-group">
                    <label class="form-label">Nama Toko</label>
                    <input type="text" class="form-input" name="name" required placeholder="Contoh: Cabang Jakarta">
                </div>
                <div class="form-group">
                    <label class="form-label">Lokasi / Kota</label>
                    <input type="text" class="form-input" name="location" required placeholder="Contoh: Jakarta Selatan">
                </div>
                <div class="form-group">
                    <label class="form-label">Saldo Awal (Kas)</label>
                    <input type="number" class="form-input" name="balance" value="0" min="0">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background: #e2e8f0;" onclick="app.closeModals()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ADD ITEM -->
    <div class="modal-overlay" id="modal-item">
        <div class="modal">
            <h3 style="margin-bottom: 1rem;">Tambah Barang Baru</h3>
            <form onsubmit="app.handleAddItem(event)">
                <div class="form-group">
                    <label class="form-label">Pilih Toko</label>
                    <select class="form-select" name="storeId" id="item-store-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nama Barang</label>
                    <input type="text" class="form-input" name="name" required placeholder="Contoh: Kopi Sachet">
                </div>
                <div class="row-inputs">
                    <div class="form-group">
                        <label class="form-label">Harga Beli (Modal)</label>
                        <input type="number" class="form-input" name="buyPrice" required min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Harga Jual</label>
                        <input type="number" class="form-input" name="sellPrice" required min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Stok Awal</label>
                    <input type="number" class="form-input" name="stock" value="0" min="0">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background: #e2e8f0;" onclick="app.closeModals()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Barang</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ADJUST STOCK -->
    <div class="modal-overlay" id="modal-stock-adjust">
        <div class="modal" style="max-width: 400px;">
            <h3 style="margin-bottom: 1rem;">Penyesuaian Stok</h3>
            <p id="adjust-item-name" style="margin-bottom: 1rem; color: var(--primary); font-weight: bold;"></p>
            <form onsubmit="app.handleStockAdjust(event)">
                <input type="hidden" name="itemId" id="adjust-item-id">
                <div class="form-group">
                    <label class="form-label">Jumlah Penyesuaian</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select class="form-select" name="operation" style="width: 80px;">
                            <option value="add">Tambah (+)</option>
                            <option value="reduce">Kurang (-)</option>
                        </select>
                        <input type="number" class="form-input" name="qty" required min="1" value="1">
                    </div>
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">
                        Tambah = Stok masuk (Restock). Kurang = Barang terjual/hilang.
                    </small>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background: #e2e8f0;" onclick="app.closeModals()">Batal</button>
                    <button type="submit" class="btn btn-warning">Update Stok</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL ADD TRANSACTION -->
    <div class="modal-overlay" id="modal-transaction">
        <div class="modal">
            <h3 style="margin-bottom: 1rem;">Catat Transaksi</h3>
            <form onsubmit="app.handleAddTransaction(event)">
                <div class="form-group">
                    <label class="form-label">Pilih Toko</label>
                    <select class="form-select" name="storeId" id="trx-store-select" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipe Transaksi</label>
                    <select class="form-select" name="type" required>
                        <option value="income">Pemasukan (+)</option>
                        <option value="expense">Pengeluaran (-)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Deskripsi / Kategori</label>
                    <input type="text" class="form-input" name="desc" required placeholder="Contoh: Penjualan Harian">
                </div>
                <div class="form-group">
                    <label class="form-label">Nominal (Rp)</label>
                    <input type="number" class="form-input" name="amount" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Tanggal</label>
                    <input type="date" class="form-input" name="date" required id="trx-date">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" style="background: #e2e8f0;" onclick="app.closeModals()">Batal</button>
                    <button type="submit" class="btn btn-primary">Simpan Transaksi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // --- DATA & STATE ---
        const appData = {
            stores: [
                { id: 's1', name: 'Toko Pusat', location: 'Jakarta', balance: 15000000 },
                { id: 's2', name: 'Cabang Melati', location: 'Bandung', balance: 8500000 },
                { id: 's3', name: 'Cabang Mawar', location: 'Surabaya', balance: 5200000 }
            ],
            transactions: [
                { id: 't1', storeId: 's1', type: 'income', amount: 2500000, desc: 'Penjualan Grosir', date: '2023-10-25' },
                { id: 't2', storeId: 's1', type: 'expense', amount: 500000, desc: 'Biaya Listrik & Air', date: '2023-10-26' },
                { id: 't3', storeId: 's2', type: 'income', amount: 1200000, desc: 'Penjualan Eceran', date: '2023-10-26' },
                { id: 't4', storeId: 's3', type: 'expense', amount: 750000, desc: 'Stok Barang', date: '2023-10-27' }
            ],
            inventory: [
                { id: 'i1', storeId: 's1', name: 'Beras Premium 5kg', buyPrice: 55000, sellPrice: 65000, stock: 20 },
                { id: 'i2', storeId: 's1', name: 'Minyak Goreng 2L', buyPrice: 28000, sellPrice: 32000, stock: 45 },
                { id: 'i3', storeId: 's2', name: 'Gula Pasir 1kg', buyPrice: 13000, sellPrice: 16000, stock: 4 }, // Low stock example
                { id: 'i4', storeId: 's2', name: 'Kopi Instan 12s', buyPrice: 10000, sellPrice: 12000, stock: 100 }
            ]
        };

        // --- HELPER FUNCTIONS ---
        const formatRupiah = (number) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number);
        };

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- APP CONTROLLER ---
        const app = {
            init: () => {
                document.getElementById('trx-date').valueAsDate = new Date();
                app.renderAll();
            },

            navigate: (viewId) => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(item => {
                    if(item.getAttribute('onclick').includes(viewId)) item.classList.add('active');
                });

                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');
                
                const titles = {
                    'dashboard': 'Dashboard',
                    'stores': 'Daftar Toko',
                    'inventory': 'Stok Barang',
                    'transactions': 'Riwayat Transaksi'
                };
                document.getElementById('page-title').innerText = titles[viewId];

                if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('active');
                app.renderAll();
            },

            renderAll: () => {
                app.renderDashboard();
                app.renderStores();
                app.renderInventory();
                app.renderTransactions();
                app.updateSelects();
            },

            // --- DASHBOARD LOGIC ---
            renderDashboard: () => {
                let totalBalance = 0, totalIncome = 0, totalExpense = 0;
                appData.stores.forEach(s => totalBalance += parseFloat(s.balance));
                
                appData.transactions.forEach(t => {
                    if(t.type === 'income') totalIncome += parseFloat(t.amount);
                    else totalExpense += parseFloat(t.amount);
                });

                document.getElementById('dash-total-balance').innerText = formatRupiah(totalBalance);
                document.getElementById('dash-total-income').innerText = formatRupiah(totalIncome);
                document.getElementById('dash-total-expense').innerText = formatRupiah(totalExpense);
                document.getElementById('dash-total-items').innerText = appData.inventory.length + " Item";

                const maxVal = Math.max(totalIncome, totalExpense, 1);
                const incomePct = (totalIncome / maxVal) * 80;
                const expensePct = (totalExpense / maxVal) * 80;

                document.getElementById('chart-bars').innerHTML = `
                    <div class="bar-group"><div class="bar income" style="height: ${incomePct}%;" data-value="${formatRupiah(totalIncome)}"></div><div class="bar-label">Pemasukan</div></div>
                    <div class="bar-group"><div class="bar expense" style="height: ${expensePct}%;" data-value="${formatRupiah(totalExpense)}"></div><div class="bar-label">Pengeluaran</div></div>
                `;

                const sortedTrx = [...appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                const tbody = document.getElementById('dash-recent-table');
                tbody.innerHTML = '';
                sortedTrx.forEach(t => {
                    const store = appData.stores.find(s => s.id === t.storeId);
                    const badgeClass = t.type === 'income' ? 'badge-in' : 'badge-out';
                    const label = t.type === 'income' ? 'Masuk' : 'Keluar';
                    const color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
                    tbody.innerHTML += `<tr><td>${t.date}</td><td>${store ? store.name : 'Unknown'}</td><td>${t.desc}</td><td style="color: ${color}; font-weight:bold;">${t.type === 'income' ? '+' : '-'} ${formatRupiah(t.amount)}</td><td><span class="badge ${badgeClass}">${label}</span></td></tr>`;
                });
            },

            // --- STORES LOGIC ---
            renderStores: () => {
                const container = document.getElementById('stores-grid');
                container.innerHTML = '';
                if(appData.stores.length === 0) { container.innerHTML = '<p style="color:var(--text-muted)">Belum ada toko.</p>'; return; }
                appData.stores.forEach(s => {
                    const totalAssets = appData.stores.reduce((sum, item) => sum + parseFloat(item.balance), 0);
                    const percentage = totalAssets > 0 ? (s.balance / totalAssets) * 100 : 0;
                    const card = `<div class="card" style="border-left: 5px solid var(--primary);"><div style="display:flex; justify-content:space-between; align-items:start;"><div><h3 style="margin-bottom:5px;">${s.name}</h3><p style="color:var(--text-muted); font-size:0.9rem;">üìç ${s.location}</p></div><button class="btn btn-sm btn-danger" onclick="app.deleteStore('${s.id}')">√ó</button></div><div style="margin-top: 1.5rem;"><div class="stat-label">Saldo Kas</div><div class="stat-value" style="color: var(--primary);">${formatRupiah(s.balance)}</div></div><div style="margin-top: 10px; background:#f1f5f9; height:6px; border-radius:3px; overflow:hidden;"><div style="width: ${percentage}%; background: var(--primary); height:100%;"></div></div></div>`;
                    container.innerHTML += card;
                });
            },

            deleteStore: (id) => {
                if(confirm('Hapus toko? Data transaksi & stok terkait akan tetap ada.')) {
                    appData.stores = appData.stores.filter(s => s.id !== id);
                    app.showToast('Toko dihapus', 'success');
                    app.renderAll();
                }
            },

            // --- INVENTORY LOGIC ---
            renderInventory: () => {
                const tbody = document.getElementById('inventory-table');
                tbody.innerHTML = '';
                const search = document.getElementById('search-inventory').value.toLowerCase();
                
                appData.inventory.forEach(item => {
                    const store = appData.stores.find(s => s.id === item.storeId);
                    // Filter logic
                    if (!item.name.toLowerCase().includes(search)) return;

                    const totalValue = item.stock * item.sellPrice;
                    let stockBadge = `<span style="font-weight:bold; color: var(--success);">${item.stock} Unit</span>`;
                    if(item.stock <= 5) {
                        stockBadge = `<span class="badge badge-low">Stok Menipis: ${item.stock}</span>`;
                    }

                    const row = `
                        <tr>
                            <td><strong>${item.name}</strong></td>
                            <td>${store ? store.name : '<span style="color:red">Toko Dihapus</span>'}</td>
                            <td>${formatRupiah(item.buyPrice)}</td>
                            <td>${formatRupiah(item.sellPrice)}</td>
                            <td>${stockBadge}</td>
                            <td style="color: var(--text-muted);">${formatRupiah(totalValue)}</td>
                            <td>
                                <button class="btn btn-sm" onclick="app.openStockAdjust('${item.id}')" title="Sesuaikan Stok">üì¶ Stok</button>
                                <button class="btn btn-sm btn-danger" onclick="app.deleteItem('${item.id}')">√ó</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            },

            handleAddItem: (e) => {
                e.preventDefault();
                const form = e.target;
                const newItem = {
                    id: generateId(),
                    storeId: form.storeId.value,
                    name: form.name.value,
                    buyPrice: parseFloat(form.buyPrice.value),
                    sellPrice: parseFloat(form.sellPrice.value),
                    stock: parseInt(form.stock.value)
                };
                appData.inventory.push(newItem);
                app.showToast('Barang berhasil ditambahkan', 'success');
                app.closeModals();
                form.reset();
                app.renderAll();
            },

            deleteItem: (id) => {
                if(confirm('Hapus barang ini?')) {
                    appData.inventory = appData.inventory.filter(i => i.id !== id);
                    app.renderAll();
                }
            },

            openStockAdjust: (itemId) => {
                const item = appData.inventory.find(i => i.id === itemId);
                if(!item) return;
                document.getElementById('adjust-item-id').value = itemId;
                document.getElementById('adjust-item-name').innerText = `Barang: ${item.name} (Stok Saat Ini: ${item.stock})`;
                app.openModal('stock-adjust');
            },

            handleStockAdjust: (e) => {
                e.preventDefault();
                const form = e.target;
                const itemId = form.itemId.value;
                const qty = parseInt(form.qty.value);
                const op = form.operation.value;

                const item = appData.inventory.find(i => i.id === itemId);
                if(item) {
                    if(op === 'add') {
                        item.stock += qty;
                        app.showToast(`Stok ditambah ${qty}`, 'success');
                    } else {
                        if(item.stock < qty) {
                            app.showToast('Stok tidak mencukupi!', 'error');
                            return;
                        }
                        item.stock -= qty;
                        app.showToast(`Stok dikurangi ${qty}`, 'warning');
                    }
                }
                app.closeModals();
                app.renderAll();
            },

            // --- TRANSACTIONS LOGIC ---
            renderTransactions: () => {
                const tbody = document.getElementById('transaction-table');
                tbody.innerHTML = '';
                const sorted = [...appData.transactions].sort((a,b) => new Date(b.date) - new Date(a.date));
                sorted.forEach(t => {
                    const store = appData.stores.find(s => s.id === t.storeId);
                    const badgeClass = t.type === 'income' ? 'badge-in' : 'badge-out';
                    const label = t.type === 'income' ? 'Masuk' : 'Keluar';
                    const color = t.type === 'income' ? 'var(--success)' : 'var(--danger)';
                    tbody.innerHTML += `<tr><td style="font-family:monospace; color:var(--text-muted);">#${t.id.substr(0,4)}</td><td>${t.date}</td><td>${store ? store.name : '<span style="color:red">Unknown</span>'}</td><td>${t.desc}</td><td><span class="badge ${badgeClass}">${label}</span></td><td style="color:${color}; font-weight:bold;">${t.type === 'income' ? '+' : '-'} ${formatRupiah(t.amount)}</td><td><button class="btn btn-sm btn-danger" onclick="app.deleteTransaction('${t.id}')">Hapus</button></td></tr>`;
                });
            },

            deleteTransaction: (id) => {
                const trx = appData.transactions.find(t => t.id === id);
                if(!trx) return;
                const store = appData.stores.find(s => s.id === trx.storeId);
                if(store) {
                    if(trx.type === 'income') store.balance -= parseFloat(trx.amount);
                    else store.balance += parseFloat(trx.amount);
                }
                appData.transactions = appData.transactions.filter(t => t.id !== id);
                app.showToast('Transaksi dihapus', 'success');
                app.renderAll();
            },

            handleAddTransaction: (e) => {
                e.preventDefault();
                const form = e.target;
                const storeId = form.storeId.value;
                const amount = parseFloat(form.amount.value);
                const type = form.type.value;

                const store = appData.stores.find(s => s.id === storeId);
                if(store) {
                    if(type === 'income') store.balance += amount;
                    else store.balance -= amount;
                } else { app.showToast('Error: Toko tidak valid', 'error'); return; }

                const newTrx = {
                    id: generateId(),
                    storeId: storeId, type: type, amount: amount,
                    desc: form.desc.value, date: form.date.value
                };

                appData.transactions.push(newTrx);
                app.showToast('Transaksi berhasil disimpan', 'success');
                app.closeModals();
                form.reset();
                document.getElementById('trx-date').valueAsDate = new Date();
                app.renderAll();
            },

            updateSelects: () => {
                const update = (id) => {
                    const select = document.getElementById(id);
                    select.innerHTML = '';
                    appData.stores.forEach(s => {
                        const option = document.createElement('option');
                        option.value = s.id;
                        option.textContent = s.name;
                        select.appendChild(option);
                    });
                };
                update('trx-store-select');
                update('item-store-select');
            },

            // --- MODAL & UI HELPERS ---
            openModal: (type) => { document.getElementById(`modal-${type}`).classList.add('open'); },
            closeModals: () => { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open')); },
            showToast: (message, type = 'success') => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.style.borderLeft = `4px solid ${type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : 'var(--warning)')}`;
                toast.innerText = message;
                container.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>